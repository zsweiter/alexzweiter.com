---
import "@fontsource-variable/spline-sans-mono";
import "@/assets/css/main.css";
import AppHeader from "@/components/AppHeader.astro";
import { ClientRouter } from "astro:transitions";
import { getLangFromUrl } from "@/i18n/utils";

interface Props {
    title: string;
    description: string;
    galaxy?: "reinit" | "zoomOut" | "zoomIn" | "zoomReset";
}

const { title, description, galaxy } = Astro.props;
const { pathname } = Astro.url;
const lang = getLangFromUrl(Astro.url);

const pageClass = pathname === "/" ? "page-home" : `page-${pathname.replace(/\//g, "").toLowerCase()}`;
---

<!doctype html>
<html lang={lang}>
    <head>
        <meta charset="UTF-8" />
        <meta name="description" content={description} />
        <meta name="viewport" content="width=device-width" />
        <!-- <link rel="icon" href="/favicon.ico" sizes="any" /> -->
        <link rel="icon" href="/favicon.svg" type="image/svg+xml" />

        <title>{title}</title>
        <script is:inline>
            function normalizePath(path) {
                return path.replace(/\/+$/, "") || "/";
            }

            function isSameUrl(a, b) {
                return (
                    a.origin === b.origin &&
                    normalizePath(a.pathname) === normalizePath(b.pathname) &&
                    a.search === b.search
                );
            }

            document.addEventListener("click", function (e) {
                var target = e.target;
                var link = target.closest("a[href]");

                if (!link) return;
                if (link.target === "_blank") return;
                if (link.hasAttribute("download")) return;
                if (link.getAttribute("rel") === "external") return;

                var to = new URL(link.href, window.location.href);
                var from = new URL(window.location.href);

                if (isSameUrl(from, to)) {
                    e.preventDefault();
                    e.stopImmediatePropagation();

                    if (to.hash) {
                        document.querySelector(to.hash)?.scrollIntoView({
                            behavior: "smooth",
                        });
                    }
                }
            });

            if (typeof window.AppEvent !== "object") {
                window.AppEvent = {
                    subscribers: {},

                    dispatch(event, payload) {
                        if (!this.subscribers[event]) return;
                        this.subscribers[event].forEach(function (fn) {
                            fn(payload);
                        });
                    },

                    listen(event, cb) {
                        if (!this.subscribers[event]) {
                            this.subscribers[event] = [];
                        }

                        this.subscribers[event].push(cb);

                        return () => {
                            this.subscribers[event] = this.subscribers[event].filter(function (fn) {
                                return fn !== cb;
                            });
                        };
                    },
                };
            }
        </script>

        <ClientRouter />
        <style is:inline>
            html {
                background-color: black;
            }
        </style>
    </head>

    <body class={`${pageClass}`} data-galaxy={galaxy}>
        <AppHeader />
        <main class="relative z-10 w-full min-h-screen flex flex-col" transition:animate="fade">
            <slot />
        </main>

        <audio style="display:none;" id="audio-player" transition:persist></audio>
        <div id="canvas-container" class="canvas-container" transition:persist>
            <canvas id="webgl-canvas"></canvas>
        </div>
        <div class="vignette-panel vignette-panel-top"></div>
        <div class="vignette-panel vignette-panel-bottom"></div>

        <script>
            import { galaxy } from "@/webgl/background";

            document.addEventListener("astro:page-load", (a) => {
                const timeout = window.loaded ? 500 : 1000;
                setTimeout(() => {
                    document.body.classList.add("page-loaded");
                }, timeout);

                const galaxyType = document.body.getAttribute("data-galaxy");
                if (galaxyType === "reinit") {
                    galaxy.reinit();
                } else if (galaxyType === "zoomOut") {
                    galaxy.zoomOut(0.5);
                } else if (galaxyType === "zoomIn") {
                    galaxy.zoomIn();
                } else if (galaxyType === "zoomReset") {
                    galaxy.zoomReset();
                }

                document.querySelectorAll("[data-ws-staggered]").forEach((item) => {
                    Array.from(item.children).map((a, index) => {
                        const el = a as HTMLElement;
                        el.style.setProperty("--delay", `${index * 150}ms`);
                        el.style.setProperty("--translate-y", "25px");
                    });
                });

                document.querySelectorAll<HTMLElement>("[data-ws-reveal]").forEach((item) => {
                    if (item.querySelector(":scope > .ws-reveal-element")) return;

                    const wrapper = document.createElement("div");
                    wrapper.classList.add("ws-reveal-element");

                    while (item.firstChild) {
                        wrapper.appendChild(item.firstChild);
                    }

                    item.appendChild(wrapper);
                });
            });

            const audioPlayer = document.getElementById("audio-player") as HTMLAudioElement & { index: number };

            window.audio = audioPlayer;
            window.AppEvent.listen("audio:play", ({ src, index }: any) => {
                galaxy.fadedPauseSound().then(() => {
                    audioPlayer.src = src;
                    audioPlayer.index = index;
                    audioPlayer.onloadeddata = () => {
                        audioPlayer.play();
                    };
                });
            });

            window.AppEvent.listen("audio:resume", () => {
                galaxy.fadedPauseSound().then(() => {
                    audioPlayer.play();
                });
            });

            window.AppEvent.listen("audio:pause", () => {
                audioPlayer.pause();
                galaxy.fadedResumeSound();
            });

            window.AppEvent.listen("audio:seek", (percentage: number) => {
                audioPlayer.currentTime = percentage * audioPlayer.duration;
            });

            audioPlayer.addEventListener("timeupdate", () => {
                window.AppEvent.dispatch("audio:progress", {
                    currentTime: audioPlayer.currentTime,
                    duration: audioPlayer.duration,
                    progress: audioPlayer.currentTime / audioPlayer.duration || 0,
                });
            });
        </script>
        <script>
            import { galaxy } from "@/webgl/background";
            const canvas = document.querySelector<HTMLCanvasElement>("#webgl-canvas");
            if (canvas) {
                galaxy.setup(canvas);

                setTimeout(() => {
                    window.loaded = true;
                }, 100);
            }
        </script>
    </body>
</html>
